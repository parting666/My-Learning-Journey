import{i as e,n as t,r as n,t as r}from"./alchemy-provider-2577f5a5-CRgglQ12.js";import{A as i,Bt as a,C as o,Lt as s,P as c,Rt as l,T as u,Vt as ee,Y as d,_ as f,a as te,c as ne,d as re,h as p,i as ie,m as ae,o as m,r as h,s as g,u as oe,v as _,w as v,x as y,zt as se}from"./index-BRCa6BxR.js";var b=null;try{if(b=WebSocket,b==null)throw Error(`inject please`)}catch{let e=new d(n);b=function(){e.throwError(`WebSockets not supported in this environment`,d.errors.UNSUPPORTED_OPERATION,{operation:`new WebSocket()`})}}var x=function(e,t,n,r){function i(e){return e instanceof n?e:new n(function(t){t(e)})}return new(n||=Promise)(function(n,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){e.done?n(e.value):i(e.value).then(o,s)}c((r=r.apply(e,t||[])).next())})},S=new d(n),ce=1,le=class extends t{constructor(e,t){t===`any`&&S.throwError(`WebSocketProvider does not support 'any' network yet`,d.errors.UNSUPPORTED_OPERATION,{operation:`network:any`}),super(typeof e==`string`?e:`_websocket`,t),this._pollingInterval=-1,this._wsReady=!1,typeof e==`string`?i(this,`_websocket`,new b(this.connection.url)):i(this,`_websocket`,e),i(this,`_requests`,{}),i(this,`_subs`,{}),i(this,`_subIds`,{}),i(this,`_detectNetwork`,super.detectNetwork()),this.websocket.onopen=()=>{this._wsReady=!0,Object.keys(this._requests).forEach(e=>{this.websocket.send(this._requests[e].payload)})},this.websocket.onmessage=e=>{let t=e.data,n=JSON.parse(t);if(n.id!=null){let e=String(n.id),r=this._requests[e];if(delete this._requests[e],n.result!==void 0)r.callback(null,n.result),this.emit(`debug`,{action:`response`,request:JSON.parse(r.payload),response:n.result,provider:this});else{let e=null;n.error?(e=Error(n.error.message||`unknown error`),i(e,`code`,n.error.code||null),i(e,`response`,t)):e=Error(`unknown error`),r.callback(e,void 0),this.emit(`debug`,{action:`response`,error:e,request:JSON.parse(r.payload),provider:this})}}else if(n.method===`eth_subscription`){let e=this._subs[n.params.subscription];e&&e.processFunc(n.params.result)}else console.warn(`this should not happen`)};let n=setInterval(()=>{this.emit(`poll`)},1e3);n.unref&&n.unref()}get websocket(){return this._websocket}detectNetwork(){return this._detectNetwork}get pollingInterval(){return 0}resetEventsBlock(e){S.throwError(`cannot reset events block on WebSocketProvider`,d.errors.UNSUPPORTED_OPERATION,{operation:`resetEventBlock`})}set pollingInterval(e){S.throwError(`cannot set polling interval on WebSocketProvider`,d.errors.UNSUPPORTED_OPERATION,{operation:`setPollingInterval`})}poll(){return x(this,void 0,void 0,function*(){return null})}set polling(e){e&&S.throwError(`cannot set polling on WebSocketProvider`,d.errors.UNSUPPORTED_OPERATION,{operation:`setPolling`})}send(e,t){let n=ce++;return new Promise((r,i)=>{function a(e,t){return e?i(e):r(t)}let o=JSON.stringify({method:e,params:t,id:n,jsonrpc:`2.0`});this.emit(`debug`,{action:`request`,request:JSON.parse(o),provider:this}),this._requests[String(n)]={callback:a,payload:o},this._wsReady&&this.websocket.send(o)})}static defaultUrl(){return`ws://localhost:8546`}_subscribe(e,t,n){return x(this,void 0,void 0,function*(){let r=this._subIds[e];r??(r=Promise.all(t).then(e=>this.send(`eth_subscribe`,e)),this._subIds[e]=r);let i=yield r;this._subs[i]={tag:e,processFunc:n}})}_startEvent(e){switch(e.type){case`block`:this._subscribe(`block`,[`newHeads`],e=>{let t=c.from(e.number).toNumber();this._emitted.block=t,this.emit(`block`,t)});break;case`pending`:this._subscribe(`pending`,[`newPendingTransactions`],e=>{this.emit(`pending`,e)});break;case`filter`:this._subscribe(e.tag,[`logs`,this._getFilter(e.filter)],t=>{t.removed??=!1,this.emit(e.filter,this.formatter.filterLog(t))});break;case`tx`:{let t=e=>{let t=e.hash;this.getTransactionReceipt(t).then(e=>{e&&this.emit(t,e)})};t(e),this._subscribe(`tx`,[`newHeads`],e=>{this._events.filter(e=>e.type===`tx`).forEach(t)});break}case`debug`:case`poll`:case`willPoll`:case`didPoll`:case`error`:break;default:console.log(`unhandled:`,e);break}}_stopEvent(e){let t=e.tag;if(e.type===`tx`){if(this._events.filter(e=>e.type===`tx`).length)return;t=`tx`}else if(this.listenerCount(e.event))return;let n=this._subIds[t];n&&(delete this._subIds[t],n.then(e=>{this._subs[e]&&(delete this._subs[e],this.send(`eth_unsubscribe`,[e]))}))}destroy(){return x(this,void 0,void 0,function*(){this.websocket.readyState===b.CONNECTING&&(yield new Promise(e=>{this.websocket.onopen=function(){e(!0)},this.websocket.onerror=function(){e(!1)}})),this.websocket.close(1e3)})}},ue=s((e=>{Object.defineProperty(e,`__esModule`,{value:!0});var t=`Provided shouldReconnect() returned false. Closing permanently.`,n=`Provided shouldReconnect() resolved to false. Closing permanently.`,r=function(){function e(t,n,r){if(r===void 0&&(r={}),this.url=t,this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this.ondown=null,this.onreopen=null,this.CONNECTING=e.CONNECTING,this.OPEN=e.OPEN,this.CLOSING=e.CLOSING,this.CLOSED=e.CLOSED,this.hasBeenOpened=!1,this.isClosed=!1,this.messageBuffer=[],this.nextRetryTime=0,this.reconnectCount=0,this.lastKnownExtensions=``,this.lastKnownProtocol=``,this.listeners={},n==null||typeof n==`string`||Array.isArray(n)?this.protocols=n:r=n,this.options=i(r),!this.options.wsConstructor)if(typeof WebSocket<`u`)this.options.wsConstructor=WebSocket;else throw Error(`WebSocket not present in global scope and no wsConstructor option was provided.`);this.openNewWebSocket()}return Object.defineProperty(e.prototype,`binaryType`,{get:function(){return this.binaryTypeInternal||`blob`},set:function(e){this.binaryTypeInternal=e,this.ws&&(this.ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,`bufferedAmount`,{get:function(){var e=this.ws?this.ws.bufferedAmount:0,t=!1;return this.messageBuffer.forEach(function(n){var r=a(n);r==null?t=!0:e+=r}),t&&this.debugLog(`Some buffered data had unknown length. bufferedAmount() return value may be below the correct amount.`),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,`extensions`,{get:function(){return this.ws?this.ws.extensions:this.lastKnownExtensions},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,`protocol`,{get:function(){return this.ws?this.ws.protocol:this.lastKnownProtocol},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,`readyState`,{get:function(){return this.isClosed?e.CLOSED:e.OPEN},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){this.disposeSocket(e,t),this.shutdown(),this.debugLog(`WebSocket permanently closed by client.`)},e.prototype.send=function(e){if(this.isClosed)throw Error(`WebSocket is already in CLOSING or CLOSED state.`);this.ws&&this.ws.readyState===this.OPEN?this.ws.send(e):this.messageBuffer.push(e)},e.prototype.reconnect=function(){if(this.isClosed)throw Error(`Cannot call reconnect() on socket which is permanently closed.`);this.disposeSocket(1e3,`Client requested reconnect.`),this.handleClose(void 0)},e.prototype.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.dispatchEvent=function(e){return this.dispatchEventOfType(e.type,e)},e.prototype.removeEventListener=function(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(function(e){return e!==t}))},e.prototype.openNewWebSocket=function(){var e=this;if(!this.isClosed){var t=this.options,n=t.connectTimeout,r=t.wsConstructor;this.debugLog(`Opening new WebSocket to `+this.url+`.`);var i=new r(this.url,this.protocols);i.onclose=function(t){return e.handleClose(t)},i.onerror=function(t){return e.handleError(t)},i.onmessage=function(t){return e.handleMessage(t)},i.onopen=function(t){return e.handleOpen(t)},this.connectTimeoutId=setTimeout(function(){e.clearConnectTimeout(),e.disposeSocket(),e.handleClose(void 0)},n),this.ws=i}},e.prototype.handleOpen=function(e){var t=this;if(!(!this.ws||this.isClosed)){var n=this.options.allClearResetTime;this.debugLog(`WebSocket opened.`),this.binaryTypeInternal==null?this.binaryTypeInternal=this.ws.binaryType:this.ws.binaryType=this.binaryTypeInternal,this.clearConnectTimeout(),this.hasBeenOpened?this.dispatchEventOfType(`reopen`,e):(this.dispatchEventOfType(`open`,e),this.hasBeenOpened=!0),this.messageBuffer.forEach(function(e){return t.send(e)}),this.messageBuffer=[],this.allClearTimeoutId=setTimeout(function(){t.clearAllClearTimeout(),t.nextRetryTime=0,t.reconnectCount=0;var e=n/1e3|0;t.debugLog(`WebSocket remained open for `+e+` seconds. Resetting retry time and count.`)},n)}},e.prototype.handleMessage=function(e){this.isClosed||this.dispatchEventOfType(`message`,e)},e.prototype.handleClose=function(e){var r=this;if(!this.isClosed){var i=this.options,a=i.maxReconnectAttempts,o=i.shouldReconnect;if(this.clearConnectTimeout(),this.clearAllClearTimeout(),this.ws&&(this.lastKnownExtensions=this.ws.extensions,this.lastKnownProtocol=this.ws.protocol,this.disposeSocket()),this.dispatchEventOfType(`down`,e),this.reconnectCount>=a){this.stopReconnecting(e,this.getTooManyFailedReconnectsMessage());return}var s=!e||o(e);typeof s==`boolean`?this.handleWillReconnect(s,e,t):s.then(function(t){r.isClosed||r.handleWillReconnect(t,e,n)})}},e.prototype.handleError=function(e){this.dispatchEventOfType(`error`,e),this.debugLog(`WebSocket encountered an error.`)},e.prototype.handleWillReconnect=function(e,t,n){e?this.reestablishConnection():this.stopReconnecting(t,n)},e.prototype.reestablishConnection=function(){var e=this,t=this.options,n=t.minReconnectDelay,r=t.maxReconnectDelay,i=t.reconnectBackoffFactor;this.reconnectCount++;var a=this.nextRetryTime;this.nextRetryTime=Math.max(n,Math.min(this.nextRetryTime*i,r)),setTimeout(function(){return e.openNewWebSocket()},a);var o=a/1e3|0;this.debugLog(`WebSocket was closed. Re-opening in `+o+` seconds.`)},e.prototype.stopReconnecting=function(e,t){this.debugLog(t),this.shutdown(),e&&this.dispatchEventOfType(`close`,e)},e.prototype.shutdown=function(){this.isClosed=!0,this.clearAllTimeouts(),this.messageBuffer=[],this.disposeSocket()},e.prototype.disposeSocket=function(e,t){this.ws&&=(this.ws.onerror=s,this.ws.onclose=s,this.ws.onmessage=s,this.ws.onopen=s,this.ws.close(e,t),void 0)},e.prototype.clearAllTimeouts=function(){this.clearConnectTimeout(),this.clearAllClearTimeout()},e.prototype.clearConnectTimeout=function(){this.connectTimeoutId!=null&&(clearTimeout(this.connectTimeoutId),this.connectTimeoutId=void 0)},e.prototype.clearAllClearTimeout=function(){this.allClearTimeoutId!=null&&(clearTimeout(this.allClearTimeoutId),this.allClearTimeoutId=void 0)},e.prototype.dispatchEventOfType=function(e,t){var n=this;switch(e){case`close`:this.onclose&&this.onclose(t);break;case`error`:this.onerror&&this.onerror(t);break;case`message`:this.onmessage&&this.onmessage(t);break;case`open`:this.onopen&&this.onopen(t);break;case`down`:this.ondown&&this.ondown(t);break;case`reopen`:this.onreopen&&this.onreopen(t);break}return e in this.listeners&&this.listeners[e].slice().forEach(function(e){return n.callListener(e,t)}),!t||!t.defaultPrevented},e.prototype.callListener=function(e,t){typeof e==`function`?e.call(this,t):e.handleEvent.call(this,t)},e.prototype.debugLog=function(e){this.options.debug&&console.log(e)},e.prototype.getTooManyFailedReconnectsMessage=function(){var e=this.options.maxReconnectAttempts;return`Failed to reconnect after `+e+` `+o(`attempt`,e)+`. Closing permanently.`},e.DEFAULT_OPTIONS={allClearResetTime:5e3,connectTimeout:5e3,debug:!1,minReconnectDelay:1e3,maxReconnectDelay:3e4,maxReconnectAttempts:1/0,reconnectBackoffFactor:1.5,shouldReconnect:function(){return!0},wsConstructor:void 0},e.CONNECTING=0,e.OPEN=1,e.CLOSING=2,e.CLOSED=3,e}();e.default=r;function i(e){var t={};return Object.keys(r.DEFAULT_OPTIONS).forEach(function(n){var i=e[n];t[n]=i===void 0?r.DEFAULT_OPTIONS[n]:i}),t}function a(e){if(typeof e==`string`)return 2*e.length;if(e instanceof ArrayBuffer)return e.byteLength;if(e instanceof Blob)return e.size}function o(e,t){return t===1?e:e+`s`}function s(){}})),C=s(((e,t)=>{var n=function(){if(typeof self==`object`&&self)return self;if(typeof window==`object`&&window)return window;throw Error("Unable to resolve global `this`")};t.exports=(function(){if(this)return this;if(typeof globalThis==`object`&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,`__global__`,{get:function(){return this},configurable:!0})}catch{return n()}try{return __global__||n()}finally{delete Object.prototype.__global__}})()})),de=se({author:()=>D,browser:()=>z,config:()=>F,contributors:()=>O,default:()=>V,dependencies:()=>N,description:()=>T,devDependencies:()=>P,directories:()=>R,engines:()=>M,homepage:()=>j,keywords:()=>E,license:()=>B,main:()=>L,name:()=>w,repository:()=>A,scripts:()=>I,version:()=>k}),w,T,E,D,O,k,A,j,M,N,P,F,I,L,R,z,B,V,H=l((()=>{w=`websocket`,T=`Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.`,E=[`websocket`,`websockets`,`socket`,`networking`,`comet`,`push`,`RFC-6455`,`realtime`,`server`,`client`],D=`Brian McKelvey <theturtle32@gmail.com> (https://github.com/theturtle32)`,O=[`IÃ±aki Baz Castillo <ibc@aliax.net> (http://dev.sipdoc.net)`],k=`1.0.35`,A={type:`git`,url:`https://github.com/theturtle32/WebSocket-Node.git`},j=`https://github.com/theturtle32/WebSocket-Node`,M={node:`>=4.0.0`},N={bufferutil:`^4.0.1`,debug:`^2.2.0`,"es5-ext":`^0.10.63`,"typedarray-to-buffer":`^3.1.5`,"utf-8-validate":`^5.0.2`,yaeti:`^0.0.6`},P={"buffer-equal":`^1.0.0`,gulp:`^4.0.2`,"gulp-jshint":`^2.0.4`,"jshint-stylish":`^2.2.1`,jshint:`^2.0.0`,tape:`^4.9.1`},F={verbose:!1},I={test:`tape test/unit/*.js`,gulp:`gulp`},L=`index`,R={lib:`./lib`},z=`lib/browser.js`,B=`Apache-2.0`,V={name:w,description:T,keywords:E,author:D,contributors:O,version:k,repository:A,homepage:j,engines:M,dependencies:N,devDependencies:P,config:F,scripts:I,main:L,directories:R,browser:z,license:B}})),fe=s(((e,t)=>{t.exports=(H(),a(de).default).version})),pe=s(((e,t)=>{var n;if(typeof globalThis==`object`)n=globalThis;else try{n=C()}catch{}finally{if(!n&&typeof window<`u`&&(n=window),!n)throw Error(`Could not determine global this`)}var r=n.WebSocket||n.MozWebSocket,i=fe();function a(e,t){return t?new r(e,t):new r(e)}r&&[`CONNECTING`,`OPEN`,`CLOSING`,`CLOSED`].forEach(function(e){Object.defineProperty(a,e,{get:function(){return r[e]}})}),t.exports={w3cwebsocket:r?a:null,version:i}})),me=ee(ue()),he=120,U=class{constructor(e){this.provider=e,this.maxBackfillBlocks=he}getNewHeadsBackfill(e,t,n){return p(this,void 0,void 0,function*(){K(e);let r=yield this.getBlockNumber();if(K(e),t.length===0)return this.getHeadEventsInRange(Math.max(n,r-this.maxBackfillBlocks)+1,r+1);let i=f(t[t.length-1].number),a=r-this.maxBackfillBlocks+1;if(i<=a)return this.getHeadEventsInRange(a,r+1);let o=yield this.getReorgHeads(e,t);K(e);let s=yield this.getHeadEventsInRange(i+1,r+1);return K(e),[...o,...s]})}getLogsBackfill(e,t,n,r){return p(this,void 0,void 0,function*(){K(e);let i=yield this.getBlockNumber();if(K(e),n.length===0)return this.getLogsInRange(t,Math.max(r,i-this.maxBackfillBlocks)+1,i+1);let a=f(n[n.length-1].blockNumber),o=i-this.maxBackfillBlocks+1;if(a<o)return this.getLogsInRange(t,o,i+1);let s=yield this.getCommonAncestor(e,n);K(e);let c=n.filter(e=>f(e.blockNumber)>s.blockNumber).map(e=>Object.assign(Object.assign({},e),{removed:!0})),l=s.blockNumber===-1/0?f(n[0].blockNumber):s.blockNumber,u=yield this.getLogsInRange(t,l,i+1);return u=u.filter(e=>e&&(f(e.blockNumber)>s.blockNumber||f(e.logIndex)>s.logIndex)),K(e),[...c,...u]})}setMaxBackfillBlock(e){this.maxBackfillBlocks=e}getBlockNumber(){return p(this,void 0,void 0,function*(){return f(yield this.provider.send(`eth_blockNumber`))})}getHeadEventsInRange(e,t){return p(this,void 0,void 0,function*(){if(e>=t)return[];let n=[];for(let r=e;r<t;r++)n.push({method:`eth_getBlockByNumber`,params:[v(r),!1]});return(yield this.provider.sendBatch(n)).map(W)})}getReorgHeads(e,t){return p(this,void 0,void 0,function*(){let n=[];for(let r=t.length-1;r>=0;r--){let i=t[r],a=yield this.getBlockByNumber(f(i.number));if(K(e),i.hash===a.hash)break;n.push(W(a))}return n.reverse()})}getBlockByNumber(e){return p(this,void 0,void 0,function*(){return this.provider.send(`eth_getBlockByNumber`,[v(e),!1])})}getCommonAncestor(e,t){return p(this,void 0,void 0,function*(){let n=yield this.getBlockByNumber(f(t[t.length-1].blockNumber));K(e);for(let e=t.length-1;e>=0;e--){let r=t[e];if(r.blockNumber!==n.number&&(n=yield this.getBlockByNumber(f(r.blockNumber))),r.blockHash===n.hash)return{blockNumber:f(r.blockNumber),logIndex:f(r.logIndex)}}return{blockNumber:-1/0,logIndex:-1/0}})}getLogsInRange(e,t,n){return p(this,void 0,void 0,function*(){if(t>=n)return[];let r=Object.assign(Object.assign({},e),{fromBlock:v(t),toBlock:v(n-1)});return this.provider.send(`eth_getLogs`,[r])})}};function W(e){let t=Object.assign({},e);return delete t.totalDifficulty,delete t.transactions,delete t.uncles,t}function ge(e){return G(e,e=>e.hash)}function _e(e){return G(e,e=>`${e.blockHash}/${e.logIndex}`)}function G(e,t){let n=new Set,r=[];return e.forEach(e=>{let i=t(e);n.has(i)||(n.add(i),r.push(e))}),r}var ve=Error(`Cancelled`);function K(e){if(e())throw ve}var ye=3e4,be=1e4,q=6e4,J=5,xe=10,Se=class extends le{constructor(e,t){let n=r.getApiKey(e.apiKey),i=r.getAlchemyNetwork(e.network),a=r.getAlchemyConnectionInfo(i,n,`wss`),s=`alchemy-sdk-${ae}`,c=new me.default(e.url??a.url,s,{wsConstructor:t??Ce()}),l=re[i];super(c,l??void 0),this._events=[],this.virtualSubscriptionsById=new Map,this.virtualIdsByPhysicalId=new Map,this.handleMessage=e=>{let t=JSON.parse(e.data);if(!je(t))return;let n=t.params.subscription,r=this.virtualIdsByPhysicalId.get(n);if(!r)return;let i=this.virtualSubscriptionsById.get(r);if(i.method===`eth_subscribe`)switch(i.params[0]){case`newHeads`:{let e=i,a=t,{isBackfilling:o,backfillBuffer:s}=e,{result:c}=a.params;o?Me(s,c):n===r?this.rememberEvent(r,c,Z):this.emitAndRememberEvent(r,c,Z);break}case`logs`:{let e=i,a=t,{isBackfilling:o,backfillBuffer:s}=e,{result:c}=a.params;o?Ne(s,c):r===n?this.rememberEvent(r,c,Q):this.emitAndRememberEvent(r,c,Q);break}default:if(n!==r){let{result:e}=t.params;this.emitEvent(r,e)}}},this.handleReopen=()=>{this.virtualIdsByPhysicalId.clear();let{cancel:e,isCancelled:t}=Te();this.cancelBackfill=e;for(let e of this.virtualSubscriptionsById.values())p(this,void 0,void 0,function*(){try{yield this.resubscribeAndBackfill(t,e)}catch(n){t()||console.error(`Error while backfilling "${e.params[0]}" subscription. Some events may be missing.`,n)}});this.startHeartbeat()},this.stopHeartbeatAndBackfill=()=>{this.heartbeatIntervalId!=null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=void 0),this.cancelBackfill()},this.apiKey=n,this.backfiller=new U(this),this.addSocketListeners(),this.startHeartbeat(),this.cancelBackfill=o}static getNetwork(t){return typeof t==`string`&&t in g?g[t]:e(t)}on(e,t){return this._addEventListener(e,t,!1)}once(e,t){return this._addEventListener(e,t,!0)}off(e,t){return y(e)?this._off(e,t):super.off(e,t)}removeAllListeners(e){return e!==void 0&&y(e)?this._removeAllListeners(e):super.removeAllListeners(e)}listenerCount(e){return e!==void 0&&y(e)?this._listenerCount(e):super.listenerCount(e)}listeners(e){return e!==void 0&&y(e)?this._listeners(e):super.listeners(e)}_addEventListener(e,t,n){if(y(e)){u(e);let r=new oe(_(e),t,n);return this._events.push(r),this._startEvent(r),this}else return super._addEventListener(e,t,n)}_startEvent(e){[...h,`block`,`filter`].includes(e.type)?this.customStartEvent(e):super._startEvent(e)}_subscribe(e,t,n,r){return p(this,void 0,void 0,function*(){let i=this._subIds[e],a=yield this.getBlockNumber();i??(i=Promise.all(t).then(e=>this.send(`eth_subscribe`,e)),this._subIds[e]=i);let o=yield i,s=yield Promise.all(t);this.virtualSubscriptionsById.set(o,{event:r,method:`eth_subscribe`,params:s,startingBlockNumber:a,virtualId:o,physicalId:o,sentEvents:[],isBackfilling:!1,backfillBuffer:[]}),this.virtualIdsByPhysicalId.set(o,o),this._subs[o]={tag:e,processFunc:n}})}emit(e,...t){if(y(e)){let n=!1,r=[],i=_(e);return this._events=this._events.filter(e=>e.tag===i?(setTimeout(()=>{e.listener.apply(this,t)},0),n=!0,e.once?(r.push(e),!1):!0):!0),r.forEach(e=>{this._stopEvent(e)}),n}else return super.emit(e,...t)}sendBatch(e){return p(this,void 0,void 0,function*(){let t=0,n=e.map(({method:e,params:n})=>({method:e,params:n,jsonrpc:`2.0`,id:`alchemy-sdk:${t++}`}));return this.sendBatchConcurrently(n)})}destroy(){return this.removeSocketListeners(),this.stopHeartbeatAndBackfill(),super.destroy()}isCommunityResource(){return this.apiKey===ne}_stopEvent(e){let t=e.tag;if(h.includes(e.type)){if(this._events.filter(e=>h.includes(e.type)).length)return}else if(e.type===`tx`){if(this._events.filter(e=>e.type===`tx`).length)return;t=`tx`}else if(this.listenerCount(e.event))return;let n=this._subIds[t];n&&(delete this._subIds[t],n.then(e=>{this._subs[e]&&(delete this._subs[e],this.send(`eth_unsubscribe`,[e]))}))}addSocketListeners(){this._websocket.addEventListener(`message`,this.handleMessage),this._websocket.addEventListener(`reopen`,this.handleReopen),this._websocket.addEventListener(`down`,this.stopHeartbeatAndBackfill)}removeSocketListeners(){this._websocket.removeEventListener(`message`,this.handleMessage),this._websocket.removeEventListener(`reopen`,this.handleReopen),this._websocket.removeEventListener(`down`,this.stopHeartbeatAndBackfill)}resubscribeAndBackfill(e,t){return p(this,void 0,void 0,function*(){let{virtualId:n,method:r,params:i,sentEvents:a,backfillBuffer:o,startingBlockNumber:s}=t;t.isBackfilling=!0,o.length=0;try{let c=yield this.send(r,i);switch(K(e),t.physicalId=c,this.virtualIdsByPhysicalId.set(c,n),i[0]){case`newHeads`:{let t=yield Y(()=>X(this.backfiller.getNewHeadsBackfill(e,a,s),q),J,()=>!e());K(e),ge([...t,...o]).forEach(e=>this.emitNewHeadsEvent(n,e));break}case`logs`:{let t=i[1]||{},r=yield Y(()=>X(this.backfiller.getLogsBackfill(e,t,a,s),q),J,()=>!e());K(e),_e([...r,...o]).forEach(e=>this.emitLogsEvent(n,e));break}default:break}}finally{t.isBackfilling=!1,o.length=0}})}emitNewHeadsEvent(e,t){this.emitAndRememberEvent(e,t,Z)}emitLogsEvent(e,t){this.emitAndRememberEvent(e,t,Q)}emitAndRememberEvent(e,t,n){this.rememberEvent(e,t,n),this.emitEvent(e,t)}emitEvent(e,t){let n=this.virtualSubscriptionsById.get(e);n&&this.emitGenericEvent(n,t)}rememberEvent(e,t,n){let r=this.virtualSubscriptionsById.get(e);r&&$(r.sentEvents,Object.assign({},t),n)}emitGenericEvent(e,t){this.emitProcessFn(e.event)(t)}startHeartbeat(){this.heartbeatIntervalId??=setInterval(()=>p(this,void 0,void 0,function*(){try{yield X(this.send(`net_version`),be)}catch{this._websocket.reconnect()}}),ye)}sendBatchConcurrently(e){return p(this,void 0,void 0,function*(){return Promise.all(e.map(e=>this.send(e.method,e.params)))})}customStartEvent(e){if(e.type===`alchemy-pending-transactions`){let{fromAddress:t,toAddress:n,hashesOnly:r}=e;this._subscribe(e.tag,[m.PENDING_TRANSACTIONS,{fromAddress:t,toAddress:n,hashesOnly:r}],this.emitProcessFn(e),e)}else if(e.type===`alchemy-mined-transactions`){let{addresses:t,includeRemoved:n,hashesOnly:r}=e;this._subscribe(e.tag,[m.MINED_TRANSACTIONS,{addresses:t,includeRemoved:n,hashesOnly:r}],this.emitProcessFn(e),e)}else e.type===`block`?this._subscribe(`block`,[`newHeads`],this.emitProcessFn(e),e):e.type===`filter`&&this._subscribe(e.tag,[`logs`,this._getFilter(e.filter)],this.emitProcessFn(e),e)}emitProcessFn(e){switch(e.type){case te:return t=>this.emit({method:m.PENDING_TRANSACTIONS,fromAddress:e.fromAddress,toAddress:e.toAddress,hashesOnly:e.hashesOnly},t);case ie:return t=>this.emit({method:m.MINED_TRANSACTIONS,addresses:e.addresses,includeRemoved:e.includeRemoved,hashesOnly:e.hashesOnly},t);case`block`:return e=>{let t=c.from(e.number).toNumber();this._emitted.block=t,this.emit(`block`,t)};case`filter`:return t=>{t.removed??=!1,this.emit(e.filter,this.formatter.filterLog(t))};default:throw Error("Invalid event type to `emitProcessFn()`")}}_off(e,t){if(t==null)return this.removeAllListeners(e);let n=[],r=!1,i=_(e);return this._events=this._events.filter(e=>e.tag!==i||e.listener!=t||r?!0:(r=!0,n.push(e),!1)),n.forEach(e=>{this._stopEvent(e)}),this}_removeAllListeners(e){let t=[];if(e==null)t=this._events,this._events=[];else{let n=_(e);this._events=this._events.filter(e=>e.tag===n?(t.push(e),!1):!0)}return t.forEach(e=>{this._stopEvent(e)}),this}_listenerCount(e){if(!e)return this._events.length;let t=_(e);return this._events.filter(e=>e.tag===t).length}_listeners(e){if(e==null)return this._events.map(e=>e.listener);let t=_(e);return this._events.filter(e=>e.tag===t).map(e=>e.listener)}};function Ce(){return we()?pe().w3cwebsocket:WebSocket}function we(){return typeof process<`u`&&process!=null&&process.versions!=null&&process.versions.node!=null}function Te(){let e=!1;return{cancel:()=>e=!0,isCancelled:()=>e}}var Ee=1e3,De=2,Oe=3e4;function Y(e,t,n=()=>!0){return p(this,void 0,void 0,function*(){let r=0,i=0;for(;;)try{return yield e()}catch(e){if(i++,i>=t||!n(e)||(yield ke(r),!n(e)))throw e;r=r===0?Ee:Math.min(Oe,De*r)}})}function ke(e){return new Promise(t=>setTimeout(t,e))}function X(e,t){return Promise.race([e,new Promise((e,n)=>setTimeout(()=>n(Error(`Timeout`)),t))])}function Z(e){return f(e.number)}function Q(e){return f(e.blockNumber)}function Ae(e){return Array.isArray(e)||e.jsonrpc===`2.0`&&e.id!==void 0}function je(e){return!Ae(e)}function Me(e,t){$(e,t,Z)}function Ne(e,t){$(e,t,Q)}function $(e,t,n){let r=n(t),i=e.findIndex(e=>n(e)>r-xe);i===-1?e.length=0:e.splice(0,i),e.push(t)}export{Se as AlchemyWebSocketProvider};